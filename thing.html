<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
    <script src="http://www.skulpt.org/static/skulpt.min.js" type="text/javascript"></script>
    <script src="http://www.skulpt.org/static/skulpt-stdlib.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="parse.js"></script>
    <link type="text/css" rel="stylesheet" href="main.css">
    <script src = "draggable.js"></script>
    <script src = "panels.js"></script>
  </head>
  <body>
    <div class="header">
      <img src="OCTO-CAT.png" style="height: 50px;"></img>
      <h1 style="display:inline;font-size:4em;">blockat</h1>
    </div>
    <div class="clearfix">
      <div class="column content" style="text-align:right;">
        <h3>&nbsp;</h3>
        <p onclick="showpanel('flowcontrol')">Flow Control</p>
        <p onclick="showpanel('primitives')">Primitives</p>
        <p onclick="showpanel('logic')">Logic</p>
        <p onclick="showpanel('math')">Math</p>
        <p onclick="showpanel('uwedefined')">User-Defined</p>
      </div>
      <div class="column content">
        <h3>Templates</h3>
        <div id="semidraggablecontainer" style="position:relative">
          <div class="bottom panel" id="flowcontrol">
            <div class = "semidraggable green endswithsemicolon">
              if&nbsp;
              <div class="draggable blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
              :
              <br>
            </div>
            <div class = "semidraggable green">
              print(
              <div class="draggable blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
              )
              <br>
            </div>
            <div class = "semidraggable blue">
              <input type="number" style = "width:5em;" placeholder="number"></input>
            </div>
            <br>
            <div class = "semidraggable blue">
              x
            </div>
            <br>
            <div class = "semidraggable green">
              <div class="draggable blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
              &nbsp;=&nbsp;
              <div class="draggable blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
              <br>
            </div>
            <div class = "semidraggable red">&nbsp;&nbsp;&nbsp;&nbsp;</div>
          </div>
          <div class="bottom panel">
            <div class = "semidraggable red">&nbsp;&nbsp;&nbsp;&nbsp;</div>
          </div>
        </div>
      </div>
      <div class="column content" style="text-align:left;">
        <h3>Blocks</h3>
        <button type="button" onclick="block_to_code()">Convert to Code</button><br>
        <div id="draggablecontainer">
          <div class = "draggable green">
            print(
            <div class = "draggable blue">65</div>
            )
            <br>
          </div>
        </div>
      </div>
      <div class="column content">
        <h3>Code</h3>
        Output:
        <pre id="output" style="border: 1px solid grey; text-align: left; padding: 2px;">65</pre>
        <button type="button" onclick="runit()">Run Code</button>
        <input type="button" id="dwn-btn" value="Download Code"/>
        <br>
        <div id="editor" class="editor-window">print(65)</div>
        <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/cobalt");
        editor.getSession().setMode("ace/mode/python");
        </script>
      </div>
    </div>
    <script>
      //download editor contents as .py file
      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }
      document.getElementById("dwn-btn").addEventListener("click", function(){
        var text = editor.getValue();
        var filename = "script.py";
        download(filename, text);
      }, false);
      </script>
      <div class="footer">
        <p>This is a project for PennApps XVI by Sam Uwe Alws and Eric Zheng.</p>
      </div>
      <script type="text/javascript">
      Sk.externalLibraries = {
        numpy: {
          path: "https://raw.githubusercontent.com/waywaaard/skulpt_numpy/master/numpy/__init__.js"
        }
      }
      function outf(text) {
        var mypre = document.getElementById("output");
        mypre.innerHTML = mypre.innerHTML + text;
      }
      function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
        throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
      }
      function runit() {
        var prog = editor.getValue();
        var mypre = document.getElementById("output");
        mypre.innerHTML = '';
        Sk.pre = "output";
        Sk.configure({output:outf, read:builtinRead});
        (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
        var myPromise = Sk.misceval.asyncToPromise(function() {
          return Sk.importMainWithBody("<stdin>", false, prog, true);
        });
        myPromise.then(function(mod) {
          console.log('success');
        },
        function(err) {
          console.log(err.toString());
        });
      }
      function get_html() {
        var inputs = document.getElementById("draggablecontainer").getElementsByTagName("input");
        for (var i = 0;i<inputs.length;i++) {
          //add a temporary span that has the value as innerhtml
          var elem = inputs.item(i);
          var s = document.createElement("span");
          s.innerHTML = elem.value;
          elem.parentElement.insertBefore(s,elem);
          s.className = "temporary";
        }
        var returnVal = document.getElementById("draggablecontainer").innerHTML;
        var temps = document.getElementById("draggablecontainer").getElementsByClassName("temporary");
        for (var i = 0;i<temps.length;i++) {
          //delete all the temporary crap we made before
          var elem = temps.item(i);
          elem.parentElement.removeChild(elem);
        }
        return returnVal;
      }
      function block_to_code() {
        editor.setValue(parse(get_html()));
      }
      showpanel("flowcontrol");
      registerdragevents();
      registersemidragevents();
    </script>
  </body>
</html>
